<!DOCTYPE html>
<html>
<head>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, sans-serif; font-size: 12px; padding: 16px; background: #fff; }
    h2 { font-size: 14px; margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; color: #333; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px; font-size: 12px; }
    button { width: 100%; padding: 10px; background: #18A0FB; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    button:hover { background: #0d8de8; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #statusBox { margin-top: 12px; padding: 8px; border-radius: 4px; font-size: 11px; display: none; }
    .loading { background: #fff3cd; color: #856404; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #e7f3ff; padding: 8px; border-radius: 4px; font-size: 11px; margin-bottom: 12px; color: #0066cc; }
  </style>
</head>
<body>
  <h2>Sitemap Generator</h2>
  <div class="info">Make sure the desktop app is running at localhost:3000</div>
  
  <label>Server URL</label>
  <input type="text" id="serverUrl" value="http://localhost:3000">
  
  <label>Image Quality</label>
  <select id="imageSize">
    <option value="200">Small (200px)</option>
    <option value="300" selected>Medium (300px)</option>
    <option value="500">Large (500px)</option>
    <option value="800">XL (800px)</option>
  </select>
  
  <button id="generateBtn">Generate Sitemap</button>
  <div id="statusBox"></div>

  <script>
    (function() {
      var generateBtn = document.getElementById('generateBtn');
      var statusBox = document.getElementById('statusBox');
      
      var MAX_HEIGHT = 2500;
      
      function showStatus(msg, type) {
        statusBox.textContent = msg;
        statusBox.className = type;
        statusBox.style.display = 'block';
      }
      
      function resizeImg(blob, maxW) {
        return new Promise(function(resolve) {
          var img = new Image();
          img.onload = function() {
            var scale = maxW / img.width;
            var w = maxW;
            var h = Math.round(img.height * scale);
            
            // Cap height
            if (h > MAX_HEIGHT) {
              h = MAX_HEIGHT;
            }
            
            var c = document.createElement('canvas');
            c.width = w;
            c.height = h;
            
            var srcH = h / scale;
            c.getContext('2d').drawImage(img, 0, 0, img.width, srcH, 0, 0, w, h);
            
            // Use JPEG for large images (much smaller file size)
            var format = maxW >= 500 ? 'image/jpeg' : 'image/png';
            var quality = maxW >= 500 ? 0.85 : undefined;
            
            c.toBlob(function(b) {
              b.arrayBuffer().then(function(buf) {
                resolve({ bytes: Array.from(new Uint8Array(buf)), width: w, height: h });
              });
            }, format, quality);
          };
          img.src = URL.createObjectURL(blob);
        });
      }
      
      generateBtn.addEventListener('click', async function() {
        var serverUrl = document.getElementById('serverUrl').value.replace(/\/$/, '');
        var thumbW = parseInt(document.getElementById('imageSize').value, 10);
        
        generateBtn.disabled = true;
        showStatus('Connecting...', 'loading');
        
        try {
          var statusRes = await fetch(serverUrl + '/api/status');
          var srvStatus = await statusRes.json();
          
          if (srvStatus.status !== 'done') {
            throw new Error('Capture not done. Status: ' + srvStatus.status);
          }
          
          showStatus('Fetching sitemap...', 'loading');
          var mapRes = await fetch(serverUrl + '/sitemap.json');
          if (!mapRes.ok) throw new Error('No sitemap.json');
          var sitemap = await mapRes.json();
          
          showStatus('Loading images...', 'loading');
          var pages = [];
          var siteSlug = sitemap.site.split('.')[0];
          
          for (var i = 0; i < sitemap.pages.length; i++) {
            var pg = sitemap.pages[i];
            var deskFile = pg.desktopFile || (siteSlug + '_' + pg.slug + '_desktop.png');
            var mobFile = pg.mobileFile || (siteSlug + '_' + pg.slug + '_mobile.png');
            
            var deskData = null;
            var mobData = null;
            
            try {
              var dRes = await fetch(serverUrl + '/' + deskFile);
              if (dRes.ok) deskData = await resizeImg(await dRes.blob(), thumbW);
            } catch (e) {}
            
            try {
              var mRes = await fetch(serverUrl + '/' + mobFile);
              if (mRes.ok) mobData = await resizeImg(await mRes.blob(), Math.round(thumbW * 0.3));
            } catch (e) {}
            
            if (deskData || mobData) {
              pages.push({
                slug: pg.slug,
                title: pg.title,
                path: pg.path,
                parent: pg.parent,
                depth: pg.depth,
                desktopImage: deskData ? deskData.bytes : null,
                desktopWidth: deskData ? deskData.width : 0,
                desktopHeight: deskData ? deskData.height : 0,
                mobileImage: mobData ? mobData.bytes : null,
                mobileWidth: mobData ? mobData.width : 0,
                mobileHeight: mobData ? mobData.height : 0
              });
            }
            showStatus('Loaded ' + pages.length + '/' + sitemap.pages.length, 'loading');
          }
          
          if (pages.length === 0) throw new Error('No images found');
          
          showStatus('Creating layout...', 'loading');
          parent.postMessage({ pluginMessage: { type: 'create-sitemap', site: sitemap.site, pages: pages } }, '*');
          
        } catch (err) {
          showStatus('Error: ' + err.message, 'error');
          generateBtn.disabled = false;
        }
      });
      
      window.onmessage = function(e) {
        var msg = e.data.pluginMessage;
        if (!msg) return;
        if (msg.type === 'done') {
          showStatus('Done! ' + msg.count + ' pages', 'success');
          generateBtn.disabled = false;
        } else if (msg.type === 'error') {
          showStatus('Error: ' + msg.message, 'error');
          generateBtn.disabled = false;
        }
      };
    })();
  </script>
</body>
</html>

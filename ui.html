<!DOCTYPE html>
<html>
<head>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, sans-serif; font-size: 12px; padding: 16px; background: #fff; }
    h2 { font-size: 14px; margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; color: #333; font-weight: 500; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 12px; font-size: 12px; }
    button { width: 100%; padding: 10px; background: #18A0FB; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    button:hover { background: #0d8de8; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #statusBox { margin-top: 12px; padding: 8px; border-radius: 4px; font-size: 11px; display: none; }
    .loading { background: #fff3cd; color: #856404; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #e7f3ff; padding: 8px; border-radius: 4px; font-size: 11px; margin-bottom: 12px; color: #0066cc; }
    .refresh-btn { background: #f0f0f0; color: #333; padding: 6px 10px; font-size: 11px; margin-left: 8px; width: auto; display: inline; }
    .refresh-btn:hover { background: #e0e0e0; }
    .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .project-info { font-size: 11px; color: #666; margin-top: -8px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <h2>Sitemap Generator</h2>
  <div class="info">Make sure the desktop app is running at localhost:3000</div>
  
  <label>Server URL</label>
  <input type="text" id="serverUrl" value="http://localhost:3000">
  
  <div class="header-row">
    <label style="margin-bottom: 0;">Project</label>
    <button class="refresh-btn" onclick="loadProjects()">â†» Refresh</button>
  </div>
  <select id="projectSelect">
    <option value="">Loading projects...</option>
  </select>
  <div id="projectInfo" class="project-info"></div>
  
  <label>Image Size</label>
  <select id="imageSize">
    <option value="200">Small (200px)</option>
    <option value="300" selected>Medium (300px)</option>
    <option value="500">Large (500px)</option>
    <option value="800">XL (800px)</option>
  </select>
  
  <button id="generateBtn">Generate Sitemap</button>
  <div id="statusBox"></div>

  <script>
    (function() {
      var generateBtn = document.getElementById('generateBtn');
      var statusBox = document.getElementById('statusBox');
      var projectSelect = document.getElementById('projectSelect');
      var projectInfo = document.getElementById('projectInfo');
      
      var MAX_DIMENSION = 4096;
      var MAX_HEIGHT = 2500;
      
      function showStatus(msg, type) {
        statusBox.textContent = msg;
        statusBox.className = type;
        statusBox.style.display = 'block';
      }
      
      // Load available projects from server
      window.loadProjects = async function() {
        var serverUrl = document.getElementById('serverUrl').value.replace(/\/$/, '');
        projectSelect.innerHTML = '<option value="">Loading...</option>';
        
        try {
          var res = await fetch(serverUrl + '/api/projects');
          var projects = await res.json();
          
          if (projects.length === 0) {
            projectSelect.innerHTML = '<option value="">No projects found</option>';
            projectInfo.textContent = 'Capture a website first using the desktop app.';
            return;
          }
          
          projectSelect.innerHTML = projects.map(function(p) {
            return '<option value="' + p.id + '">' + p.site + ' (' + p.captured_at + ')</option>';
          }).join('');
          
          updateProjectInfo();
        } catch (err) {
          projectSelect.innerHTML = '<option value="">Error loading projects</option>';
          projectInfo.textContent = 'Make sure the server is running.';
        }
      };
      
      function updateProjectInfo() {
        var selected = projectSelect.options[projectSelect.selectedIndex];
        if (selected && selected.value) {
          projectInfo.textContent = 'Project ID: ' + selected.value;
        } else {
          projectInfo.textContent = '';
        }
      }
      
      projectSelect.addEventListener('change', updateProjectInfo);
      
      // Split image into tiles if > 4096px (like Insert Big Image plugin)
      function computeTileDimensions(dimension) {
        if (dimension <= MAX_DIMENSION) return [dimension];
        
        var pieces = 1;
        var currentDim;
        do {
          pieces++;
          currentDim = Math.floor(dimension / pieces);
        } while (currentDim >= MAX_DIMENSION);
        
        var remainder = dimension % currentDim;
        var result = Array(pieces - 1).fill(currentDim);
        result.push(currentDim + remainder);
        return result;
      }
      
      // Split large image into tiles
      async function splitImage(blob, maxW) {
        return new Promise(function(resolve) {
          var img = new Image();
          img.onload = function() {
            var scale = maxW / img.width;
            var w = maxW;
            var h = Math.round(img.height * scale);
            
            // Cap height
            if (h > MAX_HEIGHT) {
              h = MAX_HEIGHT;
            }
            
            // Check if we need to tile
            var widths = computeTileDimensions(w);
            var heights = computeTileDimensions(h);
            
            var tiles = [];
            var yOffset = 0;
            
            for (var hi = 0; hi < heights.length; hi++) {
              var tileH = heights[hi];
              var xOffset = 0;
              
              for (var wi = 0; wi < widths.length; wi++) {
                var tileW = widths[wi];
                
                var canvas = document.createElement('canvas');
                canvas.width = tileW;
                canvas.height = tileH;
                var ctx = canvas.getContext('2d');
                
                // Calculate source region
                var srcX = (xOffset / scale);
                var srcY = (yOffset / scale);
                var srcW = (tileW / scale);
                var srcH = (tileH / scale);
                
                ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, tileW, tileH);
                
                tiles.push({
                  canvas: canvas,
                  x: xOffset,
                  y: yOffset,
                  width: tileW,
                  height: tileH
                });
                
                xOffset += tileW;
              }
              yOffset += tileH;
            }
            
            // Convert tiles to bytes
            var promises = tiles.map(function(tile) {
              return new Promise(function(res) {
                var format = maxW >= 500 ? 'image/jpeg' : 'image/png';
                var quality = maxW >= 500 ? 0.85 : undefined;
                
                tile.canvas.toBlob(function(b) {
                  b.arrayBuffer().then(function(buf) {
                    res({
                      bytes: Array.from(new Uint8Array(buf)),
                      x: tile.x,
                      y: tile.y,
                      width: tile.width,
                      height: tile.height
                    });
                  });
                }, format, quality);
              });
            });
            
            Promise.all(promises).then(function(results) {
              resolve({
                tiles: results,
                totalWidth: w,
                totalHeight: h
              });
            });
          };
          img.src = URL.createObjectURL(blob);
        });
      }
      
      generateBtn.addEventListener('click', async function() {
        var serverUrl = document.getElementById('serverUrl').value.replace(/\/$/, '');
        var projectId = projectSelect.value;
        var thumbW = parseInt(document.getElementById('imageSize').value, 10);
        
        if (!projectId) {
          showStatus('Please select a project', 'error');
          return;
        }
        
        generateBtn.disabled = true;
        showStatus('Fetching sitemap...', 'loading');
        
        try {
          var mapRes = await fetch(serverUrl + '/api/projects/' + projectId + '/sitemap.json');
          if (!mapRes.ok) throw new Error('No sitemap.json');
          var sitemap = await mapRes.json();
          
          showStatus('Loading images...', 'loading');
          var pages = [];
          var siteSlug = sitemap.site.split('.')[0];
          
          for (var i = 0; i < sitemap.pages.length; i++) {
            var pg = sitemap.pages[i];
            var deskFile = pg.desktopFile || (siteSlug + '_' + pg.slug + '_desktop.png');
            var mobFile = pg.mobileFile || (siteSlug + '_' + pg.slug + '_mobile.png');
            
            var deskData = null;
            var mobData = null;
            
            try {
              var dRes = await fetch(serverUrl + '/api/projects/' + projectId + '/' + deskFile);
              if (dRes.ok) deskData = await splitImage(await dRes.blob(), thumbW);
            } catch (e) {}
            
            try {
              var mRes = await fetch(serverUrl + '/api/projects/' + projectId + '/' + mobFile);
              if (mRes.ok) mobData = await splitImage(await mRes.blob(), Math.round(thumbW * 0.3));
            } catch (e) {}
            
            if (deskData || mobData) {
              pages.push({
                slug: pg.slug,
                title: pg.title,
                path: pg.path,
                parent: pg.parent,
                depth: pg.depth,
                desktopTiles: deskData ? deskData.tiles : null,
                desktopWidth: deskData ? deskData.totalWidth : 0,
                desktopHeight: deskData ? deskData.totalHeight : 0,
                mobileTiles: mobData ? mobData.tiles : null,
                mobileWidth: mobData ? mobData.totalWidth : 0,
                mobileHeight: mobData ? mobData.totalHeight : 0
              });
            }
            showStatus('Loaded ' + pages.length + '/' + sitemap.pages.length, 'loading');
          }
          
          if (pages.length === 0) throw new Error('No images found');
          
          showStatus('Creating layout...', 'loading');
          parent.postMessage({ pluginMessage: { type: 'create-sitemap', site: sitemap.site, pages: pages } }, '*');
          
        } catch (err) {
          showStatus('Error: ' + err.message, 'error');
          generateBtn.disabled = false;
        }
      });
      
      window.onmessage = function(e) {
        var msg = e.data.pluginMessage;
        if (!msg) return;
        if (msg.type === 'done') {
          showStatus('Done! ' + msg.count + ' pages', 'success');
          generateBtn.disabled = false;
        } else if (msg.type === 'error') {
          showStatus('Error: ' + msg.message, 'error');
          generateBtn.disabled = false;
        }
      };
      
      // Load projects on init
      setTimeout(loadProjects, 100);
    })();
  </script>
</body>
</html>
